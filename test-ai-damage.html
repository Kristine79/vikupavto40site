<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test AI Damage Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 {
            color: #ef4444;
            text-align: center;
        }
        input[type="file"] {
            display: block;
            margin: 20px 0;
            padding: 10px;
            background: #3a3a3a;
            border: 2px solid #ef4444;
            border-radius: 5px;
            color: #fff;
            width: 100%;
        }
        button {
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin: 10px 0;
        }
        button:hover {
            background: linear-gradient(to right, #dc2626, #b91c1c);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #preview {
            margin: 20px 0;
            text-align: center;
        }
        #preview img {
            max-width: 100%;
            border-radius: 10px;
            border: 2px solid #ef4444;
        }
        #results {
            margin-top: 20px;
            padding: 20px;
            background: #3a3a3a;
            border-radius: 5px;
            border-left: 4px solid #ef4444;
        }
        .log {
            margin: 5px 0;
            padding: 8px;
            background: #1a1a1a;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó –¢–µ—Å—Ç AI –î–µ—Ç–µ–∫—Ü–∏–∏ –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π</h1>
        <p style="text-align: center; color: #999;">TensorFlow.js + COCO-SSD</p>
        
        <input type="file" id="imageInput" accept="image/*">
        
        <div id="preview"></div>
        
        <button id="analyzeBtn" disabled>ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
        
        <div id="results"></div>
    </div>

    <script>
        let model = null;
        let selectedImage = null;

        const log = (message, type = 'info') => {
            const results = document.getElementById('results');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(logDiv);
            results.scrollTop = results.scrollHeight;
        };

        // Load model on page load
        async function loadModel() {
            try {
                log('–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ COCO-SSD...', 'info');
                model = await cocoSsd.load({
                    base: 'lite_mobilenet_v2'
                });
                log('‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Handle image selection
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                selectedImage = event.target.result;
                const preview = document.getElementById('preview');
                preview.innerHTML = `<img src="${selectedImage}" alt="Preview">`;
                document.getElementById('analyzeBtn').disabled = false;
                log('üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
            };
            reader.readAsDataURL(file);
        });

        // Analyze image
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            if (!selectedImage || !model) {
                log('‚ö†Ô∏è –ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ', 'warning');
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.textContent = 'üîÑ –ê–Ω–∞–ª–∏–∑...';

            try {
                log('üîç –ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...', 'info');

                // Create image element
                const img = new Image();
                img.src = selectedImage;
                
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                });

                log(`üìê –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${img.width}x${img.height}`, 'info');

                // Detect objects
                log('ü§ñ –ó–∞–ø—É—Å–∫ –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤...', 'info');
                const predictions = await model.detect(img);
                
                log(`üéØ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${predictions.length}`, 'info');

                // Filter vehicles
                const vehicles = predictions.filter(pred => 
                    ['car', 'truck', 'bus', 'motorcycle'].includes(pred.class)
                );

                if (vehicles.length === 0) {
                    log('‚ö†Ô∏è –ê–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏', 'warning');
                    log('üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —á–µ—Ç–∫–∏–º –≤–∏–¥–æ–º –∞–≤—Ç–æ–º–æ–±–∏–ª—è', 'info');
                } else {
                    log(`‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${vehicles.length}`, 'success');
                    vehicles.forEach((vehicle, i) => {
                        log(`  ${i + 1}. ${vehicle.class} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(vehicle.score * 100).toFixed(1)}%)`, 'success');
                        log(`     –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: [${vehicle.bbox.map(v => Math.round(v)).join(', ')}]`, 'info');
                    });

                    // Analyze damage (simplified)
                    log('üî¨ –ê–Ω–∞–ª–∏–∑ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π...', 'info');
                    const vehicle = vehicles[0];
                    const [x, y, width, height] = vehicle.bbox;

                    // Create canvas for pixel analysis
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    // Extract vehicle region
                    const vehicleData = ctx.getImageData(x, y, width, height);
                    const pixels = vehicleData.data;

                    // Simple damage analysis
                    let darkPixels = 0;
                    let highVariancePixels = 0;
                    const sampleSize = Math.floor(pixels.length / 4 / 100); // Sample 1% of pixels

                    for (let i = 0; i < pixels.length; i += 4 * 100) {
                        const r = pixels[i];
                        const g = pixels[i + 1];
                        const b = pixels[i + 2];
                        
                        const brightness = (r + g + b) / 3;
                        const colorVariance = Math.abs(r - g) + Math.abs(g - b) + Math.abs(b - r);
                        
                        if (brightness < 50) darkPixels++;
                        if (colorVariance > 100) highVariancePixels++;
                    }

                    const damageScore = (darkPixels + highVariancePixels) / sampleSize;
                    log(`üìä –û—Ü–µ–Ω–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π: ${damageScore.toFixed(2)}`, 'info');
                    
                    if (damageScore > 0.3) {
                        log('üî¥ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è', 'warning');
                    } else {
                        log('üü¢ –°–µ—Ä—å–µ–∑–Ω—ã—Ö –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ', 'success');
                    }
                }

                // Show all detected objects
                if (predictions.length > 0) {
                    log('üìã –í—Å–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:', 'info');
                    predictions.forEach((pred, i) => {
                        log(`  ${i + 1}. ${pred.class} (${(pred.score * 100).toFixed(1)}%)`, 'info');
                    });
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ${error.message}`, 'error');
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            }
        });

        // Load model on page load
        loadModel();
    </script>
</body>
</html>
